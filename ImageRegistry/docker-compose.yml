
version: '3.5'

services:
  ca:
    image: cfssl/cfssl
    hostname: cfssl
    domainname: cfssl
    restart: ${RESTART_POLICY}
    container_name: ca
    volumes:
      - type: bind
        source: ./mountPoints/ca
        target: /ca
    healthcheck:
      test: curl --fail http://localhost:8888/api/v1/cfssl/health || exit 1
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 10s
    entrypoint: ["cfssl", "serve", "-ca", "/ca/docker.crt", "-ca-key", "/ca/docker.key", "-ca-bundle", "/ca/ca-bundle.crt", "-address", "0.0.0.0", "-loglevel", "0"] #, "-config", "/ca/config.json"]
  ca_reverseproxy:
    restart: ${RESTART_POLICY}
    build:
      context: src/ca_reverseproxy
      dockerfile: Dockerfile
      args:
        - "basicAuthUsername=${DOCKER_CA_AUTHUSER}"
        - "basicAuthPassword=${DOCKER_CA_AUTHPASSWORD}"
        - "ForwardPort=8888"
        - "ForwardHost=ca"
    ports:
      - 80:80
      - 443:443
    volumes:
      - ca_reverseproxy_certs:/etc/nginx/conf.d
  certgetter:
    depends_on:
      - ca
    build: ./src/ca
    restart: ${RESTART_POLICY}
    volumes:
      - registry_certs:/mnt/registry_certs
      - grafana_certs:/mnt/grafana_certs
      - ca_reverseproxy_certs:/mnt/ca_reverseproxy_certs
      - registryui_reverseproxy_certs:/mnt/registryui_reverseproxy_certs
      - squid_certs:/mnt/squid_certs
    # Tried real hard to run this script with parameters, specifically the array of PSObjects. I could shell in and run the command below just fine, but could not get it in a place for the entrypoint
    # pwsh -command "& /work/New-CFSSL_Certificate.ps1 -certRequests ([PSCustomObject]@{name = 'registry'; hosts = @('ImageRegistry','localhost','127.0.0.1')},[PSCustomObject]@{name = 'grafana'; hosts = @('grafana','localhost','127.0.0.1')})"
    entrypoint: ["pwsh", "/work/New-CFSSL_Certificate.ps1"]
    healthcheck:
      test: ["CMD", "pwsh", "-c", "Test-Path", "/certs/cert.crt"]
      interval: 1m
      timeout: 10s
      retries: 3
      start_period: 10s
  dns: 
    image: coredns/coredns
    ports:
        - 53:53/udp
        - 5353:5353
        - 5392:9253
    volumes:
      - ./MountPoints/coredns:/root
    command: -conf /root/Corefile
    env_file: .env
    restart: ${RESTART_POLICY}
volumes:
  registry_data:
  registry_certs:
  registry_requested_certs:
  registry_auth:
  grafana_data:
  grafana_plugins:
  grafana_provisiong:
  grafana_home:
  grafana_logs:
  grafana_certs:
  squid_cache:
  squid_log:
  squid_certs:
  ca_reverseproxy_certs:
  registryui_reverseproxy_certs:
  dhcp_leases: